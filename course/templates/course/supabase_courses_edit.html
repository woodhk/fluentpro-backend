{% extends 'course/base.html' %}

{% block title %}Edit Course - {{ course.course_name }}{% endblock %}

{% block extra_css %}
<style>
    .edit-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .edit-header {
        background: linear-gradient(135deg, #3ECF8E 0%, #1E8B5C 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 4px 12px rgba(62, 207, 142, 0.3);
    }
    
    .edit-header h1 {
        margin: 0 0 10px 0;
        font-size: 28px;
    }
    
    .edit-status {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 15px;
    }
    
    .save-indicator {
        display: none;
        padding: 6px 12px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        font-size: 14px;
    }
    
    .save-indicator.saving {
        display: inline-block;
        animation: pulse 1s infinite;
    }
    
    .save-indicator.saved {
        display: inline-block;
        background: rgba(76, 175, 80, 0.3);
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .course-info-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        padding: 30px;
        margin-bottom: 30px;
    }
    
    .edit-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .edit-field {
        margin-bottom: 20px;
    }
    
    .edit-field label {
        display: block;
        font-weight: 600;
        color: #3c4043;
        margin-bottom: 8px;
        font-size: 14px;
    }
    
    .edit-field input,
    .edit-field textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e8eaed;
        border-radius: 8px;
        font-size: 15px;
        transition: all 0.3s ease;
        font-family: inherit;
    }
    
    .edit-field input:focus,
    .edit-field textarea:focus {
        outline: none;
        border-color: #3ECF8E;
        box-shadow: 0 0 0 3px rgba(62, 207, 142, 0.1);
    }
    
    .edit-field textarea {
        min-height: 100px;
        resize: vertical;
    }
    
    .lessons-section {
        margin-bottom: 40px;
    }
    
    .lessons-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }
    
    .lessons-header h2 {
        font-size: 24px;
        color: #3c4043;
        margin: 0;
    }
    
    .lesson-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        padding: 24px;
        margin-bottom: 20px;
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }
    
    .lesson-card:hover {
        border-color: #3ECF8E;
    }
    
    .lesson-card.editing {
        border-color: #3ECF8E;
        box-shadow: 0 4px 16px rgba(62, 207, 142, 0.2);
    }
    
    .lesson-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .lesson-title {
        font-size: 18px;
        color: #1a73e8;
        margin: 0;
    }
    
    .lesson-actions {
        display: flex;
        gap: 8px;
    }
    
    .btn-icon {
        background: #f8f9fa;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 14px;
    }
    
    .btn-icon:hover {
        background: #e8eaed;
    }
    
    .btn-save {
        background: #3ECF8E;
        color: white;
    }
    
    .btn-save:hover {
        background: #2BA96F;
    }
    
    .language-aim-group {
        background: #f8f9fa;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 12px;
    }
    
    .language-aim-group h5 {
        margin: 0 0 12px 0;
        color: #1a73e8;
        font-size: 16px;
    }
    
    .example-list {
        list-style: none;
        padding: 0;
    }
    
    .example-item {
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .example-item input {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #dadce0;
        border-radius: 6px;
        font-size: 14px;
    }
    
    .edit-history {
        margin-top: 40px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 12px;
    }
    
    .history-item {
        padding: 12px;
        border-bottom: 1px solid #e8eaed;
        font-size: 14px;
    }
    
    .history-item:last-child {
        border-bottom: none;
    }
    
    .auto-save-notice {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: #3ECF8E;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: none;
        animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    .navigation-buttons {
        position: sticky;
        top: 20px;
        z-index: 100;
        background: white;
        padding: 16px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="edit-container">
    <div class="edit-header">
        <h1>✏️ Edit Course</h1>
        <p>All changes are saved automatically</p>
        <div class="edit-status">
            <span class="save-indicator" id="saveIndicator">Saving...</span>
        </div>
    </div>
    
    <div class="navigation-buttons">
        <a href="{% url 'supabase_courses' %}" class="btn">← Back to Courses</a>
        <button class="btn btn-primary" onclick="showEditHistory()">View Edit History</button>
    </div>
    
    <div class="course-info-section">
        <h2>Course Information</h2>
        <div class="edit-grid">
            <div class="edit-field">
                <label for="courseName">Course Name</label>
                <input 
                    type="text" 
                    id="courseName" 
                    value="{{ course.course_name }}"
                    data-field="course_name"
                    data-type="course"
                    onblur="saveField(this)"
                >
            </div>
            <div class="edit-field">
                <label for="role">Role</label>
                <input 
                    type="text" 
                    id="role" 
                    value="{{ course.role }}"
                    data-field="role"
                    data-type="course"
                    onblur="saveField(this)"
                >
            </div>
            <div class="edit-field">
                <label for="industry">Industry</label>
                <input 
                    type="text" 
                    id="industry" 
                    value="{{ course.industry }}"
                    data-field="industry"
                    data-type="course"
                    onblur="saveField(this)"
                >
            </div>
        </div>
        
        {% if course.topic_description %}
        <div class="edit-field">
            <label>Topic Description</label>
            <div style="padding: 16px; background: #f8f9fa; border-radius: 8px;">
                <strong>{{ course.topic_description.topic }}</strong>
                <p style="margin-top: 8px;">{{ course.topic_description.description }}</p>
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="lessons-section">
        <div class="lessons-header">
            <h2>Lessons ({{ course.lessons|length }})</h2>
        </div>
        
        {% for lesson in course.lessons %}
        <div class="lesson-card" id="lesson-{{ lesson.id }}">
            <div class="lesson-header">
                <h3 class="lesson-title">Lesson {{ lesson.lesson_number }}: {{ lesson.lesson_title }}</h3>
                <div class="lesson-actions">
                    <button class="btn-icon" data-lesson-id="{{ lesson.id }}" onclick="toggleLessonEdit(this.dataset.lessonId)">
                        <span id="edit-btn-{{ lesson.id }}">Edit</span>
                    </button>
                </div>
            </div>
            
            <div class="lesson-content" id="lesson-content-{{ lesson.id }}">
                <!-- View Mode -->
                <div class="lesson-view" id="lesson-view-{{ lesson.id }}">
                    <div class="edit-field">
                        <label>Introduction</label>
                        <p>{{ lesson.lesson_introduction }}</p>
                    </div>
                    
                    {% if lesson.skill_aims %}
                    <div class="edit-field">
                        <label>Skill Aims</label>
                        <ul>
                            {% for aim in lesson.skill_aims %}
                            <li>{{ aim }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    {% if lesson.language_learning_aims %}
                    <div class="edit-field">
                        <label>Language Learning Aims</label>
                        {% for category, examples in lesson.language_learning_aims.items %}
                        <div class="language-aim-group">
                            <h5>{{ category }}</h5>
                            <ul class="example-list">
                                {% for example in examples %}
                                <li>"{{ example }}"</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    {% if lesson.lesson_summary %}
                    <div class="edit-field">
                        <label>Lesson Summary</label>
                        <ul>
                            {% for point in lesson.lesson_summary %}
                            <li>{{ point }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Edit Mode -->
                <div class="lesson-edit" id="lesson-edit-{{ lesson.id }}" style="display: none;">
                    <div class="edit-field">
                        <label>Title</label>
                        <input 
                            type="text" 
                            value="{{ lesson.lesson_title }}"
                            data-field="lesson_title"
                            data-type="lesson"
                            data-lesson-id="{{ lesson.id }}"
                            onblur="saveField(this)"
                        >
                    </div>
                    
                    <div class="edit-field">
                        <label>Introduction</label>
                        <textarea 
                            data-field="lesson_introduction"
                            data-type="lesson"
                            data-lesson-id="{{ lesson.id }}"
                            onblur="saveField(this)"
                        >{{ lesson.lesson_introduction }}</textarea>
                    </div>
                    
                    <div class="edit-field">
                        <label>Skill Aims (one per line)</label>
                        <textarea 
                            data-field="skill_aims"
                            data-type="lesson"
                            data-lesson-id="{{ lesson.id }}"
                            onblur="saveField(this)"
                        >{% for aim in lesson.skill_aims %}{{ aim }}
{% endfor %}</textarea>
                    </div>
                    
                    <div class="edit-field">
                        <label>Lesson Summary (one per line)</label>
                        <textarea 
                            data-field="lesson_summary"
                            data-type="lesson"
                            data-lesson-id="{{ lesson.id }}"
                            onblur="saveField(this)"
                        >{% for point in lesson.lesson_summary %}{{ point }}
{% endfor %}</textarea>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <div id="editHistory" class="edit-history" style="display: none;">
        <h3>Edit History</h3>
        <div id="historyContent"></div>
    </div>
</div>

<div class="auto-save-notice" id="autoSaveNotice">
    ✓ Changes saved
</div>

<script>
    let saveTimeout;
    const courseId = parseInt('{{ course.id }}', 10);
    
    function getCSRFToken() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        return csrfToken ? csrfToken.value : '{{ csrf_token }}';
    }
    
    function toggleLessonEdit(lessonId) {
        const viewDiv = document.getElementById(`lesson-view-${lessonId}`);
        const editDiv = document.getElementById(`lesson-edit-${lessonId}`);
        const editBtn = document.getElementById(`edit-btn-${lessonId}`);
        const lessonCard = document.getElementById(`lesson-${lessonId}`);
        
        if (viewDiv.style.display === 'none') {
            // Switch to view mode
            viewDiv.style.display = 'block';
            editDiv.style.display = 'none';
            editBtn.textContent = 'Edit';
            lessonCard.classList.remove('editing');
        } else {
            // Switch to edit mode
            viewDiv.style.display = 'none';
            editDiv.style.display = 'block';
            editBtn.textContent = 'Done';
            lessonCard.classList.add('editing');
        }
    }
    
    async function saveField(element) {
        const field = element.dataset.field;
        const type = element.dataset.type;
        const value = element.value;
        
        // Show saving indicator
        const indicator = document.getElementById('saveIndicator');
        indicator.textContent = 'Saving...';
        indicator.className = 'save-indicator saving';
        
        try {
            const endpoint = type === 'course' ? '/api/update-course/' : '/api/update-lesson/';
            const body = new URLSearchParams({
                field: field,
                value: value
            });
            
            if (type === 'course') {
                body.append('course_id', courseId);
            } else {
                body.append('lesson_id', element.dataset.lessonId);
            }
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: body
            });
            
            if (response.ok) {
                // Show saved indicator
                indicator.textContent = '✓ Saved';
                indicator.className = 'save-indicator saved';
                
                // Show auto-save notice
                const notice = document.getElementById('autoSaveNotice');
                notice.style.display = 'block';
                setTimeout(() => {
                    notice.style.display = 'none';
                }, 2000);
                
                // If saving array fields, update the view
                if (['skill_aims', 'lesson_summary'].includes(field)) {
                    const lessonId = element.dataset.lessonId;
                    const viewDiv = document.getElementById(`lesson-view-${lessonId}`);
                    // Optionally reload the lesson data
                    // await reloadLesson(lessonId);
                }
            } else {
                alert('Error saving changes');
                indicator.style.display = 'none';
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error saving changes');
            indicator.style.display = 'none';
        }
    }
    
    async function showEditHistory() {
        const historyDiv = document.getElementById('editHistory');
        const historyContent = document.getElementById('historyContent');
        
        try {
            const response = await fetch(`/api/edit-history/${courseId}/`);
            const data = await response.json();
            
            if (data.history && data.history.length > 0) {
                historyContent.innerHTML = data.history.map(item => `
                    <div class="history-item">
                        <strong>${item.field_name}</strong> changed by ${item.edited_by}<br>
                        <small>${new Date(item.edited_at).toLocaleString()}</small><br>
                        <span style="color: #888;">Old: ${item.old_value}</span><br>
                        <span style="color: #3ECF8E;">New: ${item.new_value}</span>
                    </div>
                `).join('');
            } else {
                historyContent.innerHTML = '<p>No edit history available.</p>';
            }
            
            historyDiv.style.display = 'block';
        } catch (error) {
            console.error('Error:', error);
            alert('Error loading edit history');
        }
    }
    
    // Auto-save on input with debouncing
    document.querySelectorAll('input, textarea').forEach(element => {
        element.addEventListener('input', function() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveField(this);
            }, 1000); // Save after 1 second of inactivity
        });
    });
</script>
{% csrf_token %}
{% endblock %}