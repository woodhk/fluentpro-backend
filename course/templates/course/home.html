{% extends 'course/base.html' %}
{% load static %}

{% block content %}
{% csrf_token %}

<div class="automation-container">
    <h1>FluentPro Course Generator</h1>
    
    <!-- Main Automation Section -->
    <div class="automation-card">
        <h2>Automated Course Generation</h2>
        <p>Process Google Docs → Extract Content → Generate Courses → Save to Database</p>
        
        <div id="automationControl">
            <button id="startAutomationBtn" class="btn btn-primary btn-large" onclick="startAutomation()">
                Start Automation
            </button>
        </div>
        
        <!-- Progress Section (Initially Hidden) -->
        <div id="progressSection" style="display: none;">
            <div class="progress-container">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
                <p id="progressText" class="progress-text">Initializing...</p>
            </div>
            
            <div class="stage-list">
                <div class="stage-item" id="stage-check">
                    <span class="stage-icon">○</span>
                    <span>Check for new documents</span>
                </div>
                <div class="stage-item" id="stage-rag">
                    <span class="stage-icon">○</span>
                    <span>Process with RAG</span>
                </div>
                <div class="stage-item" id="stage-generate">
                    <span class="stage-icon">○</span>
                    <span>Generate courses</span>
                </div>
                <div class="stage-item" id="stage-upload">
                    <span class="stage-icon">○</span>
                    <span>Upload to database</span>
                </div>
            </div>
        </div>
        
        <!-- Error Section (Initially Hidden) -->
        <div id="errorSection" class="error-section" style="display: none;">
            <h3>❌ Error Occurred</h3>
            <p><strong>Stage:</strong> <span id="errorStage"></span></p>
            <p><strong>Details:</strong> <span id="errorDetails"></span></p>
            <button class="btn" onclick="resetAutomation()">Try Again</button>
        </div>
        
        <!-- Success Section (Initially Hidden) -->
        <div id="successSection" class="success-section" style="display: none;">
            <h3>✅ Automation Complete</h3>
            <p id="successMessage"></p>
            <div class="button-group">
                <a href="{% url 'courses_list' %}" class="btn btn-primary">View Local Courses</a>
                <a href="{% url 'supabase_courses' %}" class="btn btn-primary">View & Edit Courses</a>
                <button class="btn" onclick="resetAutomation()">Run Again</button>
            </div>
        </div>
    </div>
    
    <!-- Manual Controls (Optional) -->
    <details class="manual-controls">
        <summary>Manual Controls</summary>
        <div class="manual-buttons">
            <button class="btn btn-small" onclick="checkForNewDocs()">Check Docs</button>
            <button class="btn btn-small" onclick="processWithRAG()">Process RAG</button>
            <button class="btn btn-small" onclick="generateCourses()">Generate Courses</button>
            <button class="btn btn-small btn-danger" onclick="clearAllDocs()">Clear All</button>
        </div>
    </details>
    
    <!-- Documents Section -->
    <div class="documents-section">
        <h2>Processed Documents</h2>
        {% if documents %}
            <div class="documents-list">
                {% for doc in documents %}
                <div class="document-item">
                    <div class="document-info">
                        <h3>{{ doc.title }}</h3>
                        <p>{{ doc.content|truncatewords:30 }}</p>
                        <small>Processed: {{ doc.processed_at|date:"Y-m-d H:i" }}</small>
                    </div>
                    <div class="document-status">
                        {% if doc.processing_completed %}
                            <span class="status-badge status-complete">✓ Complete</span>
                        {% else %}
                            <span class="status-badge status-pending">Pending</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            
            {% if documents.has_other_pages %}
            <div class="pagination">
                {% if documents.has_previous %}
                    <a href="?page={{ documents.previous_page_number }}">← Previous</a>
                {% endif %}
                <span>Page {{ documents.number }} of {{ documents.paginator.num_pages }}</span>
                {% if documents.has_next %}
                    <a href="?page={{ documents.next_page_number }}">Next →</a>
                {% endif %}
            </div>
            {% endif %}
        {% else %}
            <p class="empty-message">No documents processed yet. Start the automation to begin.</p>
        {% endif %}
    </div>
</div>

<style>
    .automation-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }
    
    h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
    }
    
    .automation-card {
        background: white;
        border-radius: 8px;
        padding: 30px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .automation-card h2 {
        margin-top: 0;
        color: #333;
    }
    
    .automation-card p {
        color: #666;
        margin-bottom: 20px;
    }
    
    .btn-large {
        padding: 15px 40px;
        font-size: 18px;
    }
    
    .progress-container {
        margin: 20px 0;
    }
    
    .progress-bar {
        width: 100%;
        height: 20px;
        background: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: #4285f4;
        width: 0%;
        transition: width 0.5s ease;
    }
    
    .progress-text {
        text-align: center;
        margin-top: 10px;
        color: #666;
    }
    
    .stage-list {
        margin-top: 20px;
    }
    
    .stage-item {
        padding: 10px;
        margin: 5px 0;
        background: #f8f9fa;
        border-radius: 6px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .stage-item.active {
        background: #e8f0fe;
        color: #1a73e8;
    }
    
    .stage-item.complete {
        background: #e6f4ea;
        color: #188038;
    }
    
    .stage-item.error {
        background: #fce8e6;
        color: #d33b2c;
    }
    
    .stage-icon {
        font-size: 20px;
    }
    
    .stage-item.active .stage-icon::after {
        content: '◉';
    }
    
    .stage-item.complete .stage-icon::after {
        content: '✓';
    }
    
    .stage-item.error .stage-icon::after {
        content: '✗';
    }
    
    .error-section {
        background: #fce8e6;
        border: 1px solid #d33b2c;
        border-radius: 6px;
        padding: 20px;
        margin-top: 20px;
    }
    
    .error-section h3 {
        color: #d33b2c;
        margin-top: 0;
    }
    
    .success-section {
        background: #e6f4ea;
        border: 1px solid #34a853;
        border-radius: 6px;
        padding: 20px;
        margin-top: 20px;
    }
    
    .success-section h3 {
        color: #188038;
        margin-top: 0;
    }
    
    .button-group {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
    }
    
    .manual-controls {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 6px;
    }
    
    .manual-controls summary {
        cursor: pointer;
        font-weight: 500;
        color: #666;
    }
    
    .manual-buttons {
        margin-top: 15px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .btn-small {
        padding: 8px 16px;
        font-size: 14px;
    }
    
    .documents-section {
        margin-top: 40px;
    }
    
    .documents-section h2 {
        color: #333;
        margin-bottom: 20px;
    }
    
    .documents-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .document-item {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .document-info h3 {
        margin: 0 0 10px 0;
        color: #333;
        font-size: 18px;
    }
    
    .document-info p {
        margin: 0 0 5px 0;
        color: #666;
    }
    
    .document-info small {
        color: #999;
    }
    
    .status-badge {
        padding: 5px 12px;
        border-radius: 16px;
        font-size: 14px;
        font-weight: 500;
    }
    
    .status-complete {
        background: #e6f4ea;
        color: #188038;
    }
    
    .status-pending {
        background: #fef7e0;
        color: #ea8600;
    }
    
    .empty-message {
        text-align: center;
        color: #666;
        padding: 40px;
        background: #f8f9fa;
        border-radius: 6px;
    }
    
    .pagination {
        text-align: center;
        margin-top: 20px;
        color: #666;
    }
    
    .pagination a {
        color: #4285f4;
        text-decoration: none;
        padding: 5px 10px;
    }
    
    .pagination a:hover {
        text-decoration: underline;
    }
    
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    
    .btn-danger:hover {
        background: #c82333;
    }
</style>

<script>
    let automationInProgress = false;
    let statusCheckInterval;
    
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }
    
    async function startAutomation() {
        if (automationInProgress) return;
        
        automationInProgress = true;
        document.getElementById('startAutomationBtn').style.display = 'none';
        document.getElementById('progressSection').style.display = 'block';
        document.getElementById('errorSection').style.display = 'none';
        document.getElementById('successSection').style.display = 'none';
        
        // Reset all stages
        document.querySelectorAll('.stage-item').forEach(item => {
            item.classList.remove('active', 'complete', 'error');
        });
        
        updateProgress(0, 'Starting automation...');
        
        try {
            // Start the check for new docs
            const response = await fetch('/api/check-new-docs/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                startStatusPolling();
            } else {
                showError('Initialization', 'Failed to start automation');
            }
        } catch (error) {
            showError('Initialization', error.message);
        }
    }
    
    function startStatusPolling() {
        statusCheckInterval = setInterval(checkStatus, 2000);
    }
    
    async function checkStatus() {
        try {
            const response = await fetch('/api/status/');
            const data = await response.json();
            
            updateAutomationDisplay(data);
            
            if (data.status === 'completed') {
                clearInterval(statusCheckInterval);
                showSuccess(data.message || 'All documents processed successfully');
                automationInProgress = false;
            } else if (data.status === 'error') {
                clearInterval(statusCheckInterval);
                showError(data.current_stage || 'Unknown', data.message || 'An error occurred');
                automationInProgress = false;
            }
        } catch (error) {
            console.error('Error checking status:', error);
        }
    }
    
    function updateAutomationDisplay(data) {
        const stages = {
            'Fetching documents': { id: 'stage-check', progress: 25 },
            'Generating embeddings': { id: 'stage-rag', progress: 50 },
            'Extracting structured content': { id: 'stage-rag', progress: 50 },
            'Course Generation Workflow': { id: 'stage-generate', progress: 75 },
            'Document Pipeline': { id: 'stage-upload', progress: 90 }
        };
        
        // Update progress based on current stage
        const stageInfo = stages[data.current_stage];
        if (stageInfo) {
            updateProgress(stageInfo.progress, data.message || data.current_stage);
            
            // Update stage indicators
            Object.keys(stages).forEach(stage => {
                const stageEl = document.getElementById(stages[stage].id);
                if (stageEl) {
                    if (stages[stage].progress < stageInfo.progress) {
                        stageEl.classList.add('complete');
                        stageEl.classList.remove('active');
                    } else if (stages[stage].progress === stageInfo.progress) {
                        stageEl.classList.add('active');
                        stageEl.classList.remove('complete');
                    }
                }
            });
        }
    }
    
    function updateProgress(percentage, text) {
        document.getElementById('progressFill').style.width = percentage + '%';
        document.getElementById('progressText').textContent = text;
    }
    
    function showError(stage, details) {
        document.getElementById('progressSection').style.display = 'none';
        document.getElementById('errorSection').style.display = 'block';
        document.getElementById('errorStage').textContent = stage;
        document.getElementById('errorDetails').textContent = details;
        
        // Mark the failed stage
        const stageMap = {
            'Fetching documents': 'stage-check',
            'Generating embeddings': 'stage-rag',
            'Extracting structured content': 'stage-rag',
            'Course Generation Workflow': 'stage-generate',
            'Document Pipeline': 'stage-upload'
        };
        
        const stageEl = document.getElementById(stageMap[stage]);
        if (stageEl) {
            stageEl.classList.add('error');
        }
    }
    
    function showSuccess(message) {
        document.getElementById('progressSection').style.display = 'none';
        document.getElementById('successSection').style.display = 'block';
        document.getElementById('successMessage').textContent = message;
        
        // Mark all stages as complete
        document.querySelectorAll('.stage-item').forEach(item => {
            item.classList.add('complete');
            item.classList.remove('active');
        });
        
        // Refresh the page after 3 seconds to show new documents
        setTimeout(() => {
            window.location.reload();
        }, 3000);
    }
    
    function resetAutomation() {
        automationInProgress = false;
        document.getElementById('startAutomationBtn').style.display = 'block';
        document.getElementById('progressSection').style.display = 'none';
        document.getElementById('errorSection').style.display = 'none';
        document.getElementById('successSection').style.display = 'none';
    }
    
    // Manual control functions
    async function checkForNewDocs() {
        const response = await fetch('/api/check-new-docs/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            alert('Started checking for new documents');
            startStatusPolling();
        } else {
            alert('Error starting document check');
        }
    }
    
    async function processWithRAG() {
        const response = await fetch('/api/process-rag/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            alert('Started RAG processing');
            startStatusPolling();
        } else {
            alert('Error starting RAG processing');
        }
    }
    
    async function generateCourses() {
        const response = await fetch('/api/generate-courses/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: 'document_id='
        });
        
        if (response.ok) {
            alert('Started course generation');
            startStatusPolling();
        } else {
            alert('Error starting course generation');
        }
    }
    
    async function clearAllDocs() {
        if (!confirm('Are you sure you want to delete ALL documents? This cannot be undone.')) {
            return;
        }
        
        const response = await fetch('/api/clear-docs/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        alert(data.message);
        if (response.ok) {
            window.location.reload();
        }
    }
</script>
{% endblock %}